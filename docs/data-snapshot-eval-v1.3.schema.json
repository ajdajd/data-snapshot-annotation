{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/schemas/data-snapshot-eval-v1.3.schema.json",
  "title": "Data Snapshot Evaluation Format (v1.3)",
  "type": "object",
  "additionalProperties": false,
  "required": ["label_map", "info", "documents", "predictions"],

  "properties": {
    "label_map": {
      "description": "Canonical mapping of integer label IDs to label names. Keys are strings that parse to positive integers.",
      "type": "object",
      "minProperties": 1,
      "additionalProperties": false,
      "patternProperties": {
        "^[1-9][0-9]*$": { "type": "string", "minLength": 1 }
      }
    },

    "info": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schema_version", "type", "coordinate_system"],
      "properties": {
        "schema_version": { "type": "string", "const": "1.3" },

        "type": {
          "description": "Whether this file is ground truth or model predictions.",
          "type": "string",
          "enum": ["ground_truth", "prediction"]
        },

        "dataset_id": {
          "description": "Identifier for the dataset (required for ground truth).",
          "type": "string",
          "minLength": 1
        },
        "created_at": {
          "description": "ISO8601 date or datetime string.",
          "type": "string",
          "minLength": 8
        },

        "run_id": {
          "description": "Identifier for a prediction run (required for predictions).",
          "type": "string",
          "minLength": 1
        },
        "model": {
          "description": "Model metadata (required for predictions).",
          "type": "object",
          "additionalProperties": true,
          "required": ["name"],
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "version": { "type": "string" },
            "notes": { "type": "string" }
          }
        },

        "coordinate_system": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "range", "origin"],
          "properties": {
            "type": { "type": "string", "const": "normalized_xyxy" },
            "range": {
              "description": "Fixed numeric range for normalized coordinates.",
              "type": "array",
              "minItems": 2,
              "maxItems": 2,
              "items": [{ "type": "number", "const": 0.0 }, { "type": "number", "const": 1.0 }]
            },
            "origin": { "type": "string", "const": "top_left" }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "ground_truth" } },
            "required": ["type"]
          },
          "then": {
            "required": ["dataset_id", "created_at"],
            "properties": {
              "run_id": false,
              "model": false
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "prediction" } },
            "required": ["type"]
          },
          "then": {
            "required": ["run_id", "model"],
            "properties": {
              "dataset_id": false
            }
          }
        }
      ]
    },

    "documents": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["doc_id", "doc_name", "doc_path"],
        "properties": {
          "doc_id": { "type": "string", "minLength": 1 },
          "doc_name": { "type": "string", "minLength": 1 },
          "doc_path": { "type": "string", "minLength": 1 }
        }
      }
    },

    "predictions": {
      "description": "Per-page container of objects. Used for both GT and predictions.",
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/pageEntry" }
    }
  },

  "$defs": {
    "bbox": {
      "description": "Normalized [x1, y1, x2, y2] in [0,1].",
      "type": "array",
      "minItems": 4,
      "maxItems": 4,
      "items": [
        { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        { "type": "number", "minimum": 0.0, "maximum": 1.0 }
      ]
    },

    "imageInfo": {
      "type": "object",
      "additionalProperties": false,
      "required": ["width_px", "height_px", "path"],
      "properties": {
        "width_px": { "type": "integer", "minimum": 1 },
        "height_px": { "type": "integer", "minimum": 1 },
        "path": { "type": "string", "minLength": 1 }
      }
    },

    "objectBase": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "label", "bbox"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },

        "label": {
          "description": "Human-readable label name (must be consistent with label_map; enforced in code).",
          "type": "string",
          "minLength": 1
        },

        "bbox": { "$ref": "#/$defs/bbox" },

        "attributes": {
          "description": "Optional free-form metadata (typically for GT).",
          "type": "object",
          "additionalProperties": true
        },

        "score": {
          "description": "Confidence score in [0,1] (required for prediction objects; forbidden for GT objects).",
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        }
      }
    },

    "pageEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["page_id", "doc_id", "page_index", "objects"],
      "properties": {
        "page_id": { "type": "string", "minLength": 1 },
        "doc_id": { "type": "string", "minLength": 1 },
        "page_index": { "type": "integer", "minimum": 0 },

        "image": { "$ref": "#/$defs/imageInfo" },

        "objects": {
          "type": "array",
          "items": { "$ref": "#/$defs/objectBase" }
        }
      }
    }
  },

  "allOf": [
    {
      "description": "Ground truth pages must include image info; prediction pages must not include image info.",
      "if": {
        "properties": {
          "info": {
            "properties": { "type": { "const": "ground_truth" } },
            "required": ["type"]
          }
        }
      },
      "then": {
        "properties": {
          "predictions": {
            "items": { "required": ["image"] }
          }
        }
      },
      "else": {
        "properties": {
          "predictions": {
            "items": {
              "not": { "required": ["image"] }
            }
          }
        }
      }
    },
    {
      "description": "Ground truth objects must not have score; prediction objects must have score.",
      "if": {
        "properties": {
          "info": {
            "properties": { "type": { "const": "ground_truth" } },
            "required": ["type"]
          }
        }
      },
      "then": {
        "properties": {
          "predictions": {
            "items": {
              "properties": {
                "objects": {
                  "items": {
                    "not": { "required": ["score"] }
                  }
                }
              }
            }
          }
        }
      },
      "else": {
        "properties": {
          "predictions": {
            "items": {
              "properties": {
                "objects": {
                  "items": { "required": ["score"] }
                }
              }
            }
          }
        }
      }
    }
  ]
}